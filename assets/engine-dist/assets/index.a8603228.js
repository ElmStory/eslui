var e=Object.defineProperty,t=Object.defineProperties,a=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,s=Object.prototype.propertyIsEnumerable,r=(t,a,i)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[a]=i,o=(e,t)=>{for(var a in t||(t={}))n.call(t,a)&&r(e,a,t[a]);if(i)for(var a of i(t))s.call(t,a)&&r(e,a,t[a]);return e},l=(e,i)=>t(e,a(i)),c=(e,t,a)=>(r(e,"symbol"!=typeof t?t+"":t,a),a);
/**
 * @license @elmstorygames/engine 0.5.0 :: 2021-10-11 1633991026675
 * Copyright (c) Elm Story Games LLC. All rights reserved.
 * See vendor.*.js for additional 3rd party copyright notices.
 */
import{D as d,l as u,a as p,j as h,r as v,R as m,u as E,v as I,d as g,p as y,b as _,c as N,e as w,f as T,g as b,Q as S,h as O,i as f}from"./vendor.4f67a139.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerpolicy&&(t.referrerPolicy=e.referrerpolicy),"use-credentials"===e.crossorigin?t.credentials="include":"anonymous"===e.crossorigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var R,C;(C=R||(R={})).BOOKMARKS="bookmarks",C.CHOICES="choices",C.CONDITIONS="conditions",C.EFFECTS="effects",C.EVENTS="events",C.GAMES="games",C.INPUTS="inputs",C.JUMPS="jumps",C.PASSAGES="passages",C.ROUTES="routes",C.SCENES="scenes",C.SETTINGS="settings",C.VARIABLES="variables";class L extends d{constructor(e){super(`esg-library-${e}`),c(this,"bookmarks"),c(this,"choices"),c(this,"conditions"),c(this,"effects"),c(this,"events"),c(this,"games"),c(this,"inputs"),c(this,"jumps"),c(this,"passages"),c(this,"routes"),c(this,"scenes"),c(this,"settings"),c(this,"variables"),this.version(6).stores({bookmarks:"&id,gameId,event,updated",choices:"&id,gameId,passageId",conditions:"&id,gameId,routeId,variableId",effects:"&id,gameId,routeId,variableId",events:"&id,gameId,destination,origin,prev,next,type,updated,[gameId+updated]",games:"&id,title,*tags,updated,template,designer,version,engine",inputs:"&id,gameId,passageId,variableId",jumps:"&id,gameId,sceneId",passages:"&id,gameId,gameOver,sceneId",routes:"&id,gameId,sceneId,originId,choiceId,inputId,originType,destinationId,destinationType",scenes:"&id,gameId,children",settings:"&id,gameId",variables:"&id,gameId,type"}),this.bookmarks=this.table(R.BOOKMARKS),this.choices=this.table(R.CHOICES),this.conditions=this.table(R.CONDITIONS),this.effects=this.table(R.EFFECTS),this.events=this.table(R.EVENTS),this.games=this.table(R.GAMES),this.inputs=this.table(R.INPUTS),this.jumps=this.table(R.JUMPS),this.passages=this.table(R.PASSAGES),this.routes=this.table(R.ROUTES),this.scenes=this.table(R.SCENES),this.settings=this.table(R.SETTINGS),this.variables=this.table(R.VARIABLES)}async saveBookmarkCollectionData(e){try{await this.transaction("rw",this.bookmarks,(async()=>await Promise.all([Object.keys(e).map((async t=>await this.bookmarks.add(e[t],e[t].id)))])))}catch(t){throw t}}async saveChoiceCollectionData(e,t){try{await this.transaction("rw",this.choices,(async()=>await Promise.all([Object.keys(t).map((async a=>await this.choices.add(l(o({},t[a]),{gameId:e}),t[a].id)))])))}catch(a){throw a}}async saveConditionCollectionData(e,t){try{await this.transaction("rw",this.conditions,(async()=>await Promise.all([Object.keys(t).map((async a=>await this.conditions.add(l(o({},t[a]),{gameId:e}),t[a].id)))])))}catch(a){throw a}}async saveEffectCollectionData(e,t){try{await this.transaction("rw",this.effects,(async()=>await Promise.all([Object.keys(t).map((async a=>await this.effects.add(l(o({},t[a]),{gameId:e}),t[a].id)))])))}catch(a){throw a}}async saveEventCollectionData(e,t){try{await this.transaction("rw",this.events,(async()=>await Promise.all([Object.keys(t).map((async a=>await this.events.add(l(o({},t[a]),{gameId:e}),t[a].id)))])))}catch(a){throw a}}async saveGameData(e){try{await this.transaction("rw",this.games,(async()=>await this.games.add(e,e.id)))}catch(t){throw t}}async saveInputCollectionData(e,t){try{await this.transaction("rw",this.inputs,(async()=>await Promise.all([Object.keys(t).map((async a=>await this.inputs.add(l(o({},t[a]),{gameId:e}),t[a].id)))])))}catch(a){throw a}}async saveJumpCollectionData(e,t){try{await this.transaction("rw",this.jumps,(async()=>await Promise.all([Object.keys(t).map((async a=>await this.jumps.add(l(o({},t[a]),{gameId:e}),t[a].id)))])))}catch(a){throw a}}async savePassageCollectionData(e,t){try{await this.transaction("rw",this.passages,(async()=>await Promise.all([Object.keys(t).map((async a=>await this.passages.add(l(o({},t[a]),{gameId:e}),t[a].id)))])))}catch(a){throw a}}async saveRouteCollectionData(e,t){try{await this.transaction("rw",this.routes,(async()=>await Promise.all([Object.keys(t).map((async a=>await this.routes.add(l(o({},t[a]),{gameId:e}),t[a].id)))])))}catch(a){throw a}}async saveSceneCollectionData(e,t){try{await this.transaction("rw",this.scenes,(async()=>await Promise.all([Object.keys(t).map((async a=>await this.scenes.add(l(o({},t[a]),{gameId:e}),t[a].id)))])))}catch(a){throw a}}async saveSettingCollectionData(e,t){try{await this.transaction("rw",this.settings,(async()=>await Promise.all([Object.keys(e).map((async a=>t?await this.settings.update(a,e[a]):await this.settings.add(e[a],e[a].id)))])))}catch(a){throw a}}async saveVariableCollectionData(e,t){try{await this.transaction("rw",this.variables,(async()=>await Promise.all([Object.keys(t).map((async a=>await this.variables.add(l(o({},t[a]),{gameId:e}),t[a].id)))])))}catch(a){throw a}}}var A,x,D,P,k,G,M,U,V,B,F,j,$,X,H,K,Y,Q;(x=A||(A={})).STUDIO="STUDIO",x.GAME="GAME",x.JUMP="JUMP",x.FOLDER="FOLDER",x.SCENE="SCENE",x.ROUTE="ROUTE",x.PASSAGE="PASSAGE",x.CHOICE="CHOICE",x.INPUT="INPUT",x.CONDITION="CONDITION",x.EFFECT="EFFECT",x.VARIABLE="VARIABLE",(P=D||(D={})).EQ="=",P.NE="!=",P.GTE=">=",P.GT=">",P.LT="<",P.LTE="<=",(G=k||(k={})).ASSIGN="=",G.ADD="+",G.SUBTRACT="-",G.MULTIPLY="*",G.DIVIDE="/",(U=M||(M={})).CHOICE="CHOICE",U.INPUT="INPUT",(B=V||(V={})).STRING="STRING",B.NUMBER="NUMBER",B.BOOLEAN="BOOLEAN",B.IMAGE="IMAGE",B.URL="URL",(j=F||(F={})).BOOK="BOOK",j.CONSOLE="CONSOLE",(X=$||($={})).OPEN_PASSAGE="OPEN_PASSAGE",X.RESET="RESET",X.TOGGLE_EXPRESSIONS="TOGGLE_EXPRESSIONS",X.TOGGLE_BLOCKED_CHOICES="TOGGLE_BLOCKED_CHOICES",X.TOGGLE_XRAY="TOGGLE_XRAY",(K=H||(H={})).EDITOR_TO_ENGINE="editor:engine:devtools:event",K.ENGINE_TO_EDITOR="engine:editor:devtools:event",(Q=Y||(Y={})).GAME_OVER="GAME_OVER",Q.CHOICE="CHOICE",Q.CHOICE_LOOPBACK="CHOICE_LOOPBACK",Q.INITIAL="INITIAL",Q.INPUT="INPUT",Q.INPUT_LOOPBACK="INPUT_LOOPBACK",Q.RESTART="RESTART";const q=(e,t)=>e.scrollIntoView({block:"end",behavior:t?"smooth":"auto"}),z=async e=>{const{children:t,copyright:a,description:i,designer:n,engine:s,id:r,jump:o,schema:l,studioId:c,studioTitle:u,tags:p,title:h,updated:v,version:m,website:E}=e._,I=await d.exists(`esg-library-${c}`);let g;if(I&&(g=await new L(c).games.get(r)),!I||I&&!g){((e,t)=>{localStorage.getItem(t)||localStorage.setItem(t,JSON.stringify({gameId:t,studioId:e}))})(c,r);const d=new L(c);try{await Promise.all([d.saveChoiceCollectionData(r,e.choices),d.saveConditionCollectionData(r,e.conditions),d.saveEffectCollectionData(r,e.effects),d.saveGameData({children:t,copyright:a,description:i,designer:n,engine:s,id:r,jump:o,schema:l,studioId:c,studioTitle:u,tags:p,title:h,updated:v,version:m,website:E}),d.saveInputCollectionData(r,e.inputs),d.saveJumpCollectionData(r,e.jumps),d.savePassageCollectionData(r,e.passages),d.saveRouteCollectionData(r,e.routes),d.saveSceneCollectionData(r,e.scenes),d.saveVariableCollectionData(r,e.variables)]),await J(c,r)}catch(y){throw y}}},J=async(e,t)=>{const a=new L(e);try{const[i,n,s]=await Promise.all([a.bookmarks.get(`___auto___${t}`),a.settings.get(`__default__${t}`),a.events.get(`___initial___${t}`)]);let r=[];if(i||r.push(a.saveBookmarkCollectionData({AUTO_ENGINE_BOOKMARK_KEY:{gameId:t,id:`___auto___${t}`,title:"___auto___",event:void 0,updated:Date.now()}})),n||r.push(a.saveSettingCollectionData({DEFAULT_ENGINE_SETTINGS:{gameId:t,id:`__default__${t}`,theme:F.CONSOLE}})),await Promise.all(r),!s){const i=await a.variables.where({gameId:t}).toArray();let n={};i.map((e=>n[e.id]=p.exports.cloneDeep(e)));const s={};Object.keys(n).map((e=>{const{title:a,type:i,initialValue:r}=p.exports.pick(n[e],["title","type","initialValue"]);s[e]={gameId:t,title:a,type:i,value:r}}));const r=await Z(e,t);r&&await a.saveEventCollectionData(t,{INITIAL_ENGINE_EVENT:{gameId:t,id:`___initial___${t}`,destination:r,state:s,type:Y.INITIAL,updated:Date.now()}})}}catch(i){throw i}},W=async(e,t,a)=>{try{const n=new L(e);try{await Promise.all([n.bookmarks.where({gameId:t}).delete(),n.events.where({gameId:t}).delete(),n.settings.where({gameId:t}).delete()]),!a&&await J(e,t)}catch(i){throw i}}catch(i){throw i}},Z=async(e,t)=>{const a=new L(e),i=await a.games.get(t);if(!i)throw"Unable to find starting location. Missing game info.";try{if(i.jump){const e=await a.jumps.get(i.jump);if(e){if(e.route[1])return e.route[1];if(!e.route[1]&&e.route[0]){const t=await a.scenes.get(e.route[0]);if(!t)return;if(t.children.length>0&&t.children[0][1])return t.children[0][1]}}}if(!i.jump){const a=new L(e),n=i.children[0]&&i.children[0][0]!==A.FOLDER?await a.scenes.get(i.children[0][1]):await a.scenes.where({gameId:t}).first();if(!n)return;if(n.children.length>0&&n.children[0][1])return n.children[0][1]}return}catch(n){throw n}},ee=async(e,t)=>{try{return await new L(e).bookmarks.get(`___auto___${t}`)}catch(a){throw a}},te=async(e,t,a)=>{try{const i=new L(e),n=await i.bookmarks.get(t);let s;return n?(s=l(o({},n),{event:a,updated:Date.now()}),await i.bookmarks.update(t,s),s):void 0}catch(i){throw i}},ae=async(e,t,a)=>{const i=await(async(e,t)=>{try{return await new L(e).effects.where({routeId:t}).toArray()}catch(a){throw a}})(e,t);if(i.length>0){const e=p.exports.cloneDeep(a);return i.map((t=>{if(t.id&&e[t.variableId])switch(t.set[1]){case k.ASSIGN:e[t.variableId].value=t.set[2];break;case k.ADD:e[t.variableId].value=`${Number(e[t.variableId].value)+Number(t.set[2])}`;break;case k.SUBTRACT:e[t.variableId].value=""+(Number(e[t.variableId].value)-Number(t.set[2]));break;case k.MULTIPLY:e[t.variableId].value=""+Number(e[t.variableId].value)*Number(t.set[2]);break;case k.DIVIDE:e[t.variableId].value=""+Number(e[t.variableId].value)/Number(t.set[2])}})),e}return a},ie=async(e,t)=>{try{await new L(e).events.add(t)}catch(a){throw a}},ne=async(e,t,a)=>{try{const i=new L(e),n=await i.events.get(t);n&&await i.events.update(t,l(o({},n),{next:a}))}catch(i){throw i}},se=async(e,t,a)=>{try{const i=new L(e),n=await i.events.get(t);n&&await i.events.update(t,l(o({},n),{updated:a||Date.now()}))}catch(i){throw i}},re=async(e,t)=>{try{return await new L(e).events.get(`___initial___${t}`)}catch(a){throw a}},oe=async(e,t)=>{try{return await new L(e).events.get(t)}catch(a){throw a}},le=async(e,t)=>{try{return await new L(e).jumps.get(t)}catch(a){throw a}},ce=async(e,t)=>{try{return await new L(e).passages.get(t)}catch(a){throw a}},de=async(e,t)=>{try{return await new L(e).routes.where({choiceId:t}).toArray()}catch(a){throw a}},ue=async(e,t,a)=>{const i=t.map((e=>e.id)),n=await(async(e,t)=>{try{return await new L(e).conditions.where("routeId").anyOf(t).toArray()}catch(a){throw a}})(e,i),s=[];return n&&await Promise.all(t.map((async t=>{await pe(e,p.exports.cloneDeep(a),n.filter((e=>e.routeId===t.id)))&&s.push(p.exports.cloneDeep(t))}))),s.length>0?s[s.length*Math.random()|0]:void 0},pe=async(e,t,a)=>{let i=0===a.length;const n=a.map((e=>e.variableId));let s;try{s=await new L(e).variables.where("id").anyOf(n).toArray()}catch(r){throw r}return a.length>0&&a.map((e=>{const a=s.find((t=>t.id===e.compare[1])),n=a&&a.type===V.NUMBER?Number(t[e.compare[0]].value):t[e.compare[0]].value;switch(e.compare[1]){case D.EQ:i=n===`${e.compare[2]}`;break;case D.GT:i=n>e.compare[2];break;case D.GTE:i=n>=e.compare[2];break;case D.LT:i=n<e.compare[2];break;case D.LTE:i=n<=e.compare[2];break;case D.NE:i=n!==e.compare[2]}})),i},he=async(e,t)=>{try{return await new L(e).scenes.get(t)}catch(a){throw a}},ve=h.exports.jsx,me=h.exports.jsxs,Ee=h.exports.Fragment;var Ie,ge;(ge=Ie||(Ie={})).APPEND_EVENTS_TO_STREAM="APPEND_EVENTS_TO_STREAM",ge.CLEAR_EVENT_STREAM="CLEAR_EVENT_STREAM",ge.SET_GAME_INFO="SET_GAME_INFO",ge.HIDE_RESET_NOTIFICATION="HIDE_RESET_NOTIFICATION",ge.PLAY="PLAY",ge.SET_INSTALLED="SET_INSTALLED",ge.SET_INSTALL_ID="SET_INSTALL_ID",ge.SET_IS_EDITOR="SET_EDITOR",ge.SET_CURRENT_EVENT="SET_CURRENT_EVENT",ge.STOP="STOP",ge.SHOW_RESET_NOTIFICATION="SHOW_RESET_NOTIFICATION",ge.TOGGLE_DEVTOOLS_BLOCKED_CHOICES="TOGGLE_DEVTOOLS_BLOCKED_CHOICES",ge.TOGGLE_DEVTOOLS_EXPRESSIONS="TOGGLE_DEVTOOLS_EXPRESSIONS",ge.TOGGLE_DEVTOOLS_XRAY="TOGGLE_DEVTOOLS_XRAY",ge.UPDATE_EVENT_IN_STREAM="UPDATE_EVENT_IN_STREAM";const ye=(e,t)=>{switch(t.type){case Ie.SET_INSTALLED:return l(o({},e),{installed:t.installed});case Ie.SET_INSTALL_ID:return l(o({},e),{installId:t.id});case Ie.SET_IS_EDITOR:return l(o({},e),{isEditor:!0});case Ie.SET_CURRENT_EVENT:return l(o({},e),{currentEvent:t.id});case Ie.CLEAR_EVENT_STREAM:return l(o({},e),{eventsInStream:[]});case Ie.APPEND_EVENTS_TO_STREAM:return t.reset?l(o({},e),{eventsInStream:t.events}):l(o({},e),{eventsInStream:[...t.events,...e.eventsInStream]});case Ie.UPDATE_EVENT_IN_STREAM:const a=e.eventsInStream.findIndex((e=>e.id===t.event.id));if(-1!==a){const i=p.exports.cloneDeep(e.eventsInStream);return i[a]=t.event,l(o({},e),{eventsInStream:i})}return e;case Ie.SET_GAME_INFO:return l(o({},e),{gameInfo:t.gameInfo});case Ie.PLAY:return l(o({},e),{currentEvent:t.fromEvent,playing:!0});case Ie.STOP:return l(o({},e),{eventsInStream:[],playing:!1});case Ie.HIDE_RESET_NOTIFICATION:return l(o({},e),{resetNotification:{message:void 0,showing:!1}});case Ie.SHOW_RESET_NOTIFICATION:return l(o({},e),{resetNotification:{message:t.message,showing:!0}});case Ie.TOGGLE_DEVTOOLS_BLOCKED_CHOICES:return l(o({},e),{devTools:l(o({},e.devTools),{blockedChoicesVisible:!e.devTools.blockedChoicesVisible})});case Ie.TOGGLE_DEVTOOLS_EXPRESSIONS:return l(o({},e),{devTools:l(o({},e.devTools),{highlightExpressions:!e.devTools.highlightExpressions})});case Ie.TOGGLE_DEVTOOLS_XRAY:return l(o({},e),{devTools:l(o({},e.devTools),{xrayVisible:!e.devTools.xrayVisible})});default:return e}},_e={currentEvent:void 0,devTools:{blockedChoicesVisible:!1,highlightExpressions:!1,xrayVisible:!1},eventsInStream:[],installed:!1,installId:void 0,isEditor:!1,gameInfo:void 0,playing:!1,resetNotification:{message:void 0,showing:!1}},Ne=v.exports.createContext({engine:_e,engineDispatch:()=>null});Ne.displayName="Context";const we=({children:e})=>{const[t,a]=v.exports.useReducer(ye,_e);return ve(Ne.Provider,{value:v.exports.useMemo((()=>({engine:t,engineDispatch:a})),[t,a]),children:e})};var Te,be;we.displayName="EngineProvider",(be=Te||(Te={})).CLOSE="CLOSE",be.OPEN="OPEN",be.SET_THEME="SET_THEME";const Se=(e,t)=>{switch(t.type){case Te.CLOSE:return l(o({},e),{open:!1});case Te.OPEN:return l(o({},e),{open:!0});case Te.SET_THEME:return l(o({},e),{theme:t.theme,open:!t.closeSettings});default:return e}},Oe={open:!1,theme:void 0},fe=v.exports.createContext({settings:Oe,settingsDispatch:()=>null});fe.displayName="Context";const Re=({children:e})=>{const[t,a]=v.exports.useReducer(Se,Oe);return ve(fe.Provider,{value:v.exports.useMemo((()=>({settings:t,settingsDispatch:a})),[t,a]),children:e})};Re.displayName="SettingsProvider";const Ce=m.memo((({children:e,studioId:t,gameId:a,data:i,isEditor:n})=>{const{engine:s,engineDispatch:r}=v.exports.useContext(Ne);return E([`installed-${s.installId}`,s.installed],(async()=>{try{return s.installed||(!n&&i&&await z(i),n&&(r({type:Ie.SET_IS_EDITOR}),r({type:Ie.HIDE_RESET_NOTIFICATION}),await W(t,a,!0),await J(t,a),s.playing&&r({type:Ie.SET_CURRENT_EVENT,id:`___initial___${a}`})),r({type:Ie.SET_INSTALLED,installed:!0}),r({type:Ie.SET_INSTALL_ID,id:I()})),!0}catch(e){throw e}}),{enabled:!s.installed}),v.exports.useEffect((()=>{!async function(){if(s.installed){const e=await(async(e,t)=>{try{const a=await new L(e).games.get(t);if(a)return a}catch(a){throw a}return null})(t,a);e&&r({type:Ie.SET_GAME_INFO,gameInfo:t?o({studioId:t},p.exports.pick(e,["copyright","description","designer","id","studioTitle","title","updated","version","website"])):p.exports.pick(e,["copyright","description","designer","id","studioId","studioTitle","title","updated","version","website"])})}}()}),[s.installed]),ve(Ee,{children:s.installed&&e})}));Ce.displayName="Installer";const Le=({onStartGame:e,onContinueGame:t})=>{const{settingsDispatch:a}=v.exports.useContext(fe),{engine:i}=v.exports.useContext(Ne);if(!i.gameInfo)return null;const{studioId:n,id:s}=i.gameInfo,r=E("autoBookmark",(async()=>await ee(n,s)));return ve(Ee,{children:i.gameInfo&&r.data&&me("div",{id:"title-card",children:[me("div",{id:"title-card-studio-title",children:[i.gameInfo.studioTitle," presents..."]}),ve("div",{id:"title-card-game-title",children:i.gameInfo.title}),me("div",{id:"title-card-game-version",children:["v",i.gameInfo.version]}),me("div",{id:"title-card-game-designer",children:["designed by ",i.gameInfo.designer]}),me("div",{id:"title-card-btns",children:[ve("button",{id:"title-card-start-btn",onClick:r.data.event?t:e,children:r.data.event?"CONTINUE":"START"}),ve("button",{id:"title-card-settings-btn",onClick:()=>a({type:Te.OPEN}),children:"SETTINGS"})]}),me("div",{id:"title-card-footer",children:["powered by ",ve("a",{href:"http://elmstory.com",children:"Elm Story"})]})]})})};Le.displayName="TitleCard";const Ae=()=>{const{engine:e,engineDispatch:t}=v.exports.useContext(Ne),{settingsDispatch:a}=v.exports.useContext(fe);return ve(Ee,{children:e.gameInfo&&me("div",{id:"event-stream-title-bar",className:"title-bar",children:[ve("button",{onClick:()=>t({type:Ie.STOP}),children:ve("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16",children:ve("path",{fillRule:"evenodd",d:"M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z"})})}),ve("span",{id:"event-stream-title-bar-game-title",className:"title-bar-title",children:e.gameInfo.title}),!e.isEditor&&ve("button",{onClick:()=>a({type:Te.OPEN}),children:ve("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16",children:ve("path",{d:"M8.932.727c-.243-.97-1.62-.97-1.864 0l-.071.286a.96.96 0 0 1-1.622.434l-.205-.211c-.695-.719-1.888-.03-1.613.931l.08.284a.96.96 0 0 1-1.186 1.187l-.284-.081c-.96-.275-1.65.918-.931 1.613l.211.205a.96.96 0 0 1-.434 1.622l-.286.071c-.97.243-.97 1.62 0 1.864l.286.071a.96.96 0 0 1 .434 1.622l-.211.205c-.719.695-.03 1.888.931 1.613l.284-.08a.96.96 0 0 1 1.187 1.187l-.081.283c-.275.96.918 1.65 1.613.931l.205-.211a.96.96 0 0 1 1.622.434l.071.286c.243.97 1.62.97 1.864 0l.071-.286a.96.96 0 0 1 1.622-.434l.205.211c.695.719 1.888.03 1.613-.931l-.08-.284a.96.96 0 0 1 1.187-1.187l.283.081c.96.275 1.65-.918.931-1.613l-.211-.205a.96.96 0 0 1 .434-1.622l.286-.071c.97-.243.97-1.62 0-1.864l-.286-.071a.96.96 0 0 1-.434-1.622l.211-.205c.719-.695.03-1.888-.931-1.613l-.284.08a.96.96 0 0 1-1.187-1.186l.081-.284c.275-.96-.918-1.65-1.613-.931l-.205.211a.96.96 0 0 1-1.622-.434L8.932.727zM8 12.997a4.998 4.998 0 1 1 0-9.995 4.998 4.998 0 0 1 0 9.996z"})})})]})})};Ae.displayName="EventStreamTitleBar";const xe=m.memo((({event:e})=>{const{engine:t}=v.exports.useContext(Ne);if(!t.gameInfo)return null;const{studioId:a,id:i}=t.gameInfo,n=g.exports.useLiveQuery((()=>new L(a).variables.where({gameId:i}).toArray()),[],[]);return me("div",{id:"engine-xray",children:[me("table",{className:"event-data",children:[ve("thead",{children:ve("tr",{children:ve("th",{colSpan:2,children:"Current Event | XRAY"})})}),me("tbody",{children:[me("tr",{children:[ve("td",{children:"ID"}),ve("td",{children:e.id})]}),me("tr",{children:[ve("td",{children:"Type"}),ve("td",{children:e.type})]}),me("tr",{children:[ve("td",{children:"Passage"}),ve("td",{children:ve("a",{title:"Goto Passage",onClick:()=>{window.dispatchEvent(new CustomEvent(H.ENGINE_TO_EDITOR,{detail:{eventType:$.OPEN_PASSAGE,passageId:e.destination}}))},children:e.destination})})]})]})]}),n.length>0&&me("table",{id:"engine-xray-variables",children:[ve("thead",{children:me("tr",{children:[ve("th",{children:"Variable Title"}),ve("th",{children:"ID"}),ve("th",{children:"Type"}),ve("th",{children:"Initial Value"}),ve("th",{children:"Current Value"})]})}),ve("tbody",{children:e&&n.length>0&&n.map((t=>{var a;const{id:i,title:n,type:s,initialValue:r}=t;return ve(Ee,{children:me("tr",{children:[ve("td",{children:n}),ve("td",{children:i}),ve("td",{children:s}),ve("td",{children:r||"undefined"}),ve("td",{children:(null==(a=e.state[i])?void 0:a.value)||"undefined"})]},`event-state-variable-${i}`)})}))})]})]})}));var De,Pe;function ke(e,t,a){const i=[];return e.map((e=>{try{const n=y(e,{ecmaVersion:2020}),s=n.body&&n.body[0],r=null==s?void 0:s.expression;if(s&&s.type===De.EXPRESSION_STATEMENT&&r)switch(r.type){case De.IDENTIFIER:i.push(function(e,t){return e.type===De.IDENTIFIER&&e.name?t[null==e?void 0:e.name]?{type:De.IDENTIFIER,variableName:e.name}:{type:De.EXPRESSION_ERROR,message:`Unable to process identifier expression. '${e.name}' is an unknown variable.`}:{type:De.EXPRESSION_ERROR,message:"Unable to process identifier expression."}}(r,t));break;case De.CALL_EXPRESSION:i.push(function(e,t,a){const i=e.callee;return i&&i.type===De.MEMBER_EXPRESSION&&i.object&&i.object.type===De.IDENTIFIER&&i.object.name&&i.property&&i.property.type===De.IDENTIFIER&&i.property.name?t[i.object.name]&&a[i.property.name]?{type:De.CALL_EXPRESSION,variableName:i.object.name,methodName:i.property.name}:{type:De.EXPRESSION_ERROR,message:`Unable to process call expression. ${t[i.object.name]?"":`Missing game variable: '${i.object.name}' `}${a[i.property.name]?"":`Missing game method: '${i.property.name}`}`}:{type:De.EXPRESSION_ERROR,message:"Unable to process call expression. Example format: '{ variableName.upper() }"}}(r,t,a));break;case De.CONDITIONAL_EXPRESSION:i.push(function(e){var t,a;const i=e.test,n=e.consequent,s=e.alternate;return!i||!n||n.type!==De.IDENTIFIER&&n.type!==De.LITERAL||void 0===n.name&&void 0===n.value||!s||s.type!==De.IDENTIFIER&&s.type!==De.LITERAL||void 0===s.name&&void 0===s.value?{type:De.EXPRESSION_ERROR,message:'Unable to process conditional expression. Example format: \'{ variableName > 0 ? "Greater than 0." : "Not greater than zero." }'}:i.type===De.UNARY_EXPRESSION&&(null==(t=i.argument)?void 0:t.type)===De.IDENTIFIER&&(null==(a=i.argument)?void 0:a.name)&&"!"===i.operator?{type:De.CONDITIONAL_EXPRESSION,argument:{name:i.argument.name,type:i.argument.type},consequent:{type:n.type,variableName:n.type===De.IDENTIFIER?n.name:void 0,value:n.type===De.LITERAL?n.value:void 0},alternate:{type:s.type,variableName:s.type===De.IDENTIFIER?s.name:void 0,value:s.type===De.LITERAL?s.value:void 0}}:i.type===De.IDENTIFIER&&i.name?{type:De.CONDITIONAL_EXPRESSION,identifier:{type:De.IDENTIFIER,variableName:i.name},consequent:{type:n.type,variableName:n.type===De.IDENTIFIER?n.name:void 0,value:n.type===De.LITERAL?n.value:void 0},alternate:{type:s.type,variableName:s.type===De.IDENTIFIER?s.name:void 0,value:s.type===De.LITERAL?s.value:void 0}}:i.type!==De.BINARY_EXPRESSION||!i.left||i.left.type!==De.IDENTIFIER&&i.left.type!==De.LITERAL||!i.operator||!i.right||i.right.type!==De.IDENTIFIER&&i.right.type!==De.LITERAL?{type:De.EXPRESSION_ERROR,message:'Unable to process conditional expression. Example format: \'{ variableName > 0 ? "Greater than 0." : "Not greater than zero." }'}:{type:De.CONDITIONAL_EXPRESSION,left:{type:i.left.type,variableName:i.left.type===De.IDENTIFIER?i.left.name:void 0,value:i.left.type===De.LITERAL?i.left.value:void 0},right:{type:i.right.type,variableName:i.right.type===De.IDENTIFIER?i.right.name:void 0,value:i.right.type===De.LITERAL?i.right.value:void 0},operator:i.operator,consequent:{type:n.type,variableName:n.type===De.IDENTIFIER?n.name:void 0,value:n.type===De.LITERAL?n.value:void 0},alternate:{type:s.type,variableName:s.type===De.IDENTIFIER?s.name:void 0,value:s.type===De.LITERAL?s.value:void 0}}}(r));break;case De.BINARY_EXPRESSION:i.push({type:De.EXPRESSION_ERROR,message:`Unable to parse template expression. '${e}' is not supported, but is planned for a future release.`});break;default:i.push({type:De.EXPRESSION_ERROR,message:`Unable to parse template expression. '${e}' is not supported.`})}else i.push({type:De.EXPRESSION_ERROR,message:`Unable to parse template expression. '${e}' is not supported.`})}catch(n){i.push({type:De.EXPRESSION_ERROR,message:`Unable to parse template expression. '${e}' is not supported.`})}})),i}function Ge(e,t,a,i,n){let s=`${e}`;return t.map(((e,t)=>{var r,o;const l=a[t];let c;switch(l.type){case De.IDENTIFIER:c=i[l.variableName].value||"undefined";break;case De.CALL_EXPRESSION:c=null==(r=n[l.methodName])?void 0:r.call(n,i[l.variableName].value);break;case De.CONDITIONAL_EXPRESSION:const e=l.left,t=l.right,a=l.operator,s=l.consequent,d=l.alternate,u=s&&s.variableName&&s.type===De.IDENTIFIER?i[s.variableName]?i[s.variableName].value||"undefined":"esg-error":s.value,p=d&&d.variableName&&d.type===De.IDENTIFIER?i[d.variableName]?i[d.variableName].value||"undefined":"esg-error":d.value,h=(null==e?void 0:e.variableName)?i[e.variableName]:void 0,v=(null==t?void 0:t.variableName)?i[t.variableName]:void 0;switch(a){case">":case">=":case"<":case"<=":if((null==e?void 0:e.variableName)&&(null==t?void 0:t.variableName))if(h&&h.type===V.NUMBER&&h.value&&v&&v.type===V.NUMBER&&v.value)switch(a){case">":c=Number(h.value)>Number(v.value)?u:p;break;case">=":c=Number(h.value)>=Number(v.value)?u:p;break;case"<":c=Number(h.value)<Number(v.value)?u:p;break;case"<=":c=Number(h.value)<=Number(v.value)?u:p;break;default:c="esg-error"}else c="esg-error";if((null==e?void 0:e.variableName)&&t&&!t.variableName||(null==t?void 0:t.variableName)&&e&&!e.variableName)if(h&&h.type===V.NUMBER&&h.value&&(t.value||0===t.value)&&"number"==typeof t.value||v&&v.type===V.NUMBER&&v.value&&(e.value||0===e.value)&&"number"==typeof e.value)switch(a){case">":c=Number((null==h?void 0:h.value)||e.value)>Number((null==v?void 0:v.value)||t.value)?u:p;break;case">=":c=Number((null==h?void 0:h.value)||e.value)>=Number((null==v?void 0:v.value)||t.value)?u:p;break;case"<":c=Number((null==h?void 0:h.value)||e.value)<Number((null==v?void 0:v.value)||t.value)?u:p;break;case"<=":c=Number((null==h?void 0:h.value)||e.value)<=Number((null==v?void 0:v.value)||t.value)?u:p;break;default:c="esg-error"}else c="esg-error";c||(c="esg-error");break;case"==":case"!=":h&&v&&(h.type===V.BOOLEAN&&v.type===V.BOOLEAN&&(c="=="===a?"true"===h.value&&"true"===v.value||"false"===h.value&&"false"===v.value?u:p:"true"===h.value&&"false"===v.value||"false"===h.value&&"true"===v.value?u:p),!c&&h.value&&v.value&&(c="=="===a?h.value===v.value?u:p:h.value!==v.value?u:p)),h&&!v&&(h.type===V.BOOLEAN&&"boolean"==typeof(null==t?void 0:t.value)&&(c="=="===a?"true"===h.value&&t.value||"false"===h.value&&!t.value?u:p:"false"===h.value&&t.value||"true"===h.value&&!t.value?u:p),h.type===V.NUMBER&&"number"==typeof(null==t?void 0:t.value)&&(c="=="===a?Number(h.value)===t.value?u:p:Number(h.value)!==t.value?u:p),!c&&h.value&&(null==t?void 0:t.value)&&(c="=="===a?h.value===(null==t?void 0:t.value)?u:p:h.value!==(null==t?void 0:t.value)?u:p)),!h&&v&&(v.type===V.BOOLEAN&&"boolean"==typeof(null==e?void 0:e.value)&&(c="=="===a?"true"===v.value&&e.value||"false"===v.value&&!e.value?u:p:"false"===v.value&&e.value||"true"===v.value&&!e.value?u:p),v.type===V.NUMBER&&"number"==typeof(null==e?void 0:e.value)&&(c="=="===a?Number(v.value)===e.value?u:p:Number(v.value)!==e.value?u:p),!c&&v.value&&(null==e?void 0:e.value)&&(c="=="===a?v.value===(null==e?void 0:e.value)?u:p:v.value!==(null==e?void 0:e.value)?u:p)),c||(c="esg-error");break;default:c="esg-error"}if(null==(o=l.identifier)?void 0:o.variableName){const e=i[l.identifier.variableName];e&&(e.type===V.BOOLEAN&&(c="true"===e.value?u:p),e.type!==V.BOOLEAN&&(c=e&&e.value?u:p)),e||(c="esg-error")}if(l.argument&&l.argument.name&&l.argument.type){const e=i[l.argument.name];e&&(c=e.type===V.BOOLEAN&&"false"===e.value?u:p),e||(c="esg-error")}break;case De.EXPRESSION_ERROR:c="esg-error"}c=c?`{${c}}`:"",s=s.split("{"+e+"}").join(c||"")})),s.replace(/\s+/g," ").trim()}xe.displayName="EventPassageXRay",(Pe=De||(De={})).EXPRESSION_ERROR="ExpressionError",Pe.EXPRESSION_STATEMENT="ExpressionStatement",Pe.IDENTIFIER="Identifier",Pe.LITERAL="Literal",Pe.CALL_EXPRESSION="CallExpression",Pe.CONDITIONAL_EXPRESSION="ConditionalExpression",Pe.BINARY_EXPRESSION="BinaryExpression",Pe.MEMBER_EXPRESSION="MemberExpression",Pe.UNARY_EXPRESSION="UnaryExpression";const Me={lower:e=>e.toLowerCase(),upper:e=>e.toUpperCase()},Ue=(e,t,a)=>{const[i,n]=((e,t)=>{const a=function(e){const t=e.match(/{([^}]+)}/g);return t?t.map((e=>e.replace(/{|}/g,""))):[]}(e),i={};return Object.entries(t).map((e=>{const t=e[1];i[t.title]={value:t.value,type:t.type}})),[Ge(e,a,ke(a,i,Me),i,Me),a]})(e,t);let s=0;return _(i,/{([^}]+)}/g,(e=>{const t=n[s];return s++,a?ve("span",{className:"esg-error"===e?"expression-error":"expression",title:t,children:"esg-error"===e?"ERROR":e},`expression-${s}`):"esg-error"===e?ve("span",{className:"expression-error",title:t,children:"ERROR"},`expression-${s}`):ve("span",{children:e},`span-${s}`)}))},Ve=m.memo((({content:e,state:t})=>{const{engine:a}=v.exports.useContext(Ne),i=JSON.parse(e);return me(Ee,{children:[i.map(((e,i)=>ve("p",{children:Ue(e.children[0].text,t,a.devTools.highlightExpressions)},`content-p-text-${i}`))),!i[0].children[0].text&&1===i.length&&ve("div",{className:"engine-warning-message",children:"Passage content required."})]})}));Ve.displayName="EventPassageContent";const Be=me(Ee,{children:[ve("svg",{width:"16",height:"16",viewBox:"0 0 16 16",fill:"currentColor",xmlns:"http://www.w3.org/2000/svg",className:"event-loopback-btn-content",children:ve("path",{d:"M14.854 4.854C14.9006 4.80755 14.9375 4.75238 14.9627 4.69163C14.9879 4.63089 15.0009 4.56577 15.0009 4.5C15.0009 4.43423 14.9879 4.36911 14.9627 4.30836C14.9375 4.24762 14.9006 4.19244 14.854 4.146L10.854 0.145998C10.7601 0.0521117 10.6328 -0.00063324 10.5 -0.00063324C10.3672 -0.00063324 10.2399 0.0521117 10.146 0.145998C10.0521 0.239885 9.99937 0.367223 9.99937 0.499998C9.99937 0.632774 10.0521 0.760112 10.146 0.853998L13.293 4H3.5C2.83696 4 2.20107 4.26339 1.73223 4.73223C1.26339 5.20107 1 5.83696 1 6.5L1 10.5C1 11.163 1.26339 11.7989 1.73223 12.2678C2.20107 12.7366 2.83696 13 3.5 13H10.5C10.6326 13 10.7598 12.9473 10.8536 12.8536C10.9473 12.7598 11 12.6326 11 12.5C11 12.3674 10.9473 12.2402 10.8536 12.1464C10.7598 12.0527 10.6326 12 10.5 12H3.5C3.10218 12 2.72064 11.842 2.43934 11.5607C2.15804 11.2794 2 10.8978 2 10.5L2 6.5C2 6.10217 2.15804 5.72064 2.43934 5.43934C2.72064 5.15803 3.10218 5 3.5 5H13.293L10.146 8.146C10.0521 8.23988 9.99937 8.36722 9.99937 8.5C9.99937 8.63277 10.0521 8.76011 10.146 8.854C10.2399 8.94788 10.3672 9.00063 10.5 9.00063C10.6328 9.00063 10.7601 8.94788 10.854 8.854L14.854 4.854Z",fillRule:"evenodd"})}),"RETURN"]}),Fe=m.memo((({onClick:e,eventResult:t})=>ve("div",{className:"event-loopback-btn "+("___loopback___"===(null==t?void 0:t.value)?"event-choice-result":""),children:ve("button",{onClick:e,type:e?void 0:"submit",disabled:"___loopback___"===(null==t?void 0:t.value),children:Be})})));Fe.displayName="EventLoopbackButton";const je=m.memo((({routes:e,event:t,onSubmitRoute:a,originId:i})=>{var n,s;const{engine:r}=v.exports.useContext(Ne);if(!r.gameInfo)return null;const{studioId:o,id:l}=r.gameInfo,c=g.exports.useLiveQuery((()=>new L(o).conditions.where({gameId:l}).toArray()),[]),d=g.exports.useLiveQuery((()=>new L(o).variables.where({gameId:l}).toArray()),[]),{data:u,isLoading:p}=E([`passthrough-${t.id}`,e,c,d],(async()=>await ue(o,e,t.state))),h=v.exports.useCallback((async()=>u&&!p&&await a({originId:i,route:u,result:{value:"___passthrough___"}})),[u]);return ve("div",{className:"event-choice "+("___passthrough___"===(null==(n=t.result)?void 0:n.value)?"event-choice-result":""),children:ve(Ee,{children:ve("button",{onClick:h,disabled:!(!t.result&&(u||p)),className:t.result||u||p?"":"closed-route",children:"___passthrough___"===(null==(s=t.result)?void 0:s.value)||r.currentEvent!==t.id||u||p?"Continue":"Route Required"})})})}));je.displayName="EventPassagePassthroughChoice";const $e=m.memo((({data:e,eventResult:t,onSubmitRoute:a,openRoute:i,originId:n})=>{const s=v.exports.useCallback((async()=>i&&await a({originId:n,route:i,result:{id:e.id,value:e.title}})),[i]);return ve(Ee,{children:(!t||i)&&ve("div",{className:"event-choice "+((null==t?void 0:t.id)===e.id?"event-choice-result":""),children:ve("button",{onClick:s,disabled:!(!t&&i),className:i?"":"closed-route",children:e.title})})})}));$e.displayName="EventPassageChoice";const Xe=m.memo((({passage:e,event:t,onSubmitRoute:a})=>{var i,n;const s=v.exports.useRef(null),{engine:r,engineDispatch:o}=v.exports.useContext(Ne);if(!r.gameInfo)return null;const{studioId:l,id:c}=r.gameInfo,d=g.exports.useLiveQuery((async()=>{const a=await new L(l).choices.where({passageId:e.id}).toArray();try{if(a){const{filteredChoices:i,openRoutes:n}=await Promise.resolve((async(e,t,a,i)=>{const n=t,s={};return{filteredChoices:(await Promise.all(n.map((async t=>{const n=await de(e,t.id);if(n){const i=await ue(e,n,a);if(i)return s[t.id]=p.exports.cloneDeep(i),t}return i?t:void 0})))).filter((e=>void 0!==e)),openRoutes:s}})(l,a,t.state,!!r.devTools.blockedChoicesVisible));return i.sort(((t,a)=>e.choices.findIndex((e=>t.id===e))-e.choices.findIndex((e=>a.id===e)))).map((e=>({data:e,openRoute:n[e.id]})))}return[]}catch(i){throw i}}),[e,t,r.devTools.blockedChoicesVisible]),u=g.exports.useLiveQuery((async()=>(await new L(l).routes.where({originId:e.id}).toArray()).filter((e=>void 0===e.choiceId))),[e,t,r.devTools.blockedChoicesVisible]),h=v.exports.useCallback((async()=>{t.prev&&t.origin?await a({originId:t.origin,result:{value:"___loopback___"}}):o({type:Ie.SHOW_RESET_NOTIFICATION,message:"Unable to return. Missing route."})}),[t]),m=v.exports.useCallback((async()=>{a({result:{value:"___gameover___"}})}),[t]);return me("div",{className:"event-choices",ref:s,children:[!e.gameOver&&d&&u&&me(Ee,{children:[u.length>0&&ve(Ee,{children:ve(je,{routes:u,event:t,onSubmitRoute:a,originId:t.origin})}),0===u.length&&ve(Ee,{children:d.map((({data:e,openRoute:i})=>ve($e,{data:e,eventResult:t.result,onSubmitRoute:a,openRoute:i,originId:t.origin},e.id)))}),0===d.length&&0===u.length&&ve("div",{className:"event-choice",children:me(Ee,{children:[r.currentEvent!==`___initial___${c}`&&me(Ee,{children:[(!t.result||"___loopback___"===t.result.value)&&ve(Fe,{onClick:h,eventResult:t.result}),"___passthrough___"===(null==(i=t.result)?void 0:i.value)&&ve(je,{routes:u,event:t,onSubmitRoute:a,originId:t.origin})]}),r.currentEvent===`___initial___${c}`&&ve("button",{disabled:!0,className:"closed-route",children:"Route Required"})]})}),!d&&e.choices.map((e=>ve("div",{className:"event-choice",children:ve("button",{style:{opacity:0},children:"-"})},e)))]}),e.gameOver&&me(Ee,{children:[ve("div",{className:"event-choice",children:ve("button",{onClick:m,disabled:!!t.result,children:Ke((null==(n=t.result)?void 0:n.value)||"New Game")})}),!r.isEditor&&ve("div",{className:"event-choice",children:ve("button",{onClick:()=>o({type:Ie.STOP}),children:"Title Screen"})})]})]})}));Xe.displayName="EventPassageChoices";const He=m.memo((({passage:e,event:t,onSubmitRoute:a})=>{const{engine:i}=v.exports.useContext(Ne);if(!i.gameInfo)return null;const{studioId:n}=i.gameInfo,s=v.exports.useRef(null),[r,o]=v.exports.useState(""),[l,c]=v.exports.useState(!1),d=g.exports.useLiveQuery((()=>new L(n).inputs.where({passageId:e.id}).first())),u=g.exports.useLiveQuery((async()=>{let e;if((null==d?void 0:d.variableId)&&(e=await new L(n).variables.get(d.variableId),e)){let a=t.state[e.id].value;switch(t.state[e.id].type){case V.NUMBER:a=Number(a);break;default:a=void 0}o(a||(null==e?void 0:e.initialValue))}return e}),[d]),h=v.exports.useCallback((async e=>{if(d&&u&&r){const i=p.exports.cloneDeep(t.state);i[u.id].value=e||`${r}`;const s=await ue(n,await(async(e,t)=>{try{return await new L(e).routes.where({inputId:t}).toArray()}catch(a){throw a}})(n,d.id),i);(s||t.origin)&&(c(!1),a({originId:t.origin,result:{id:d.id,value:e?"true"===e?"Yes":"No":`${r}`},route:s,state:i})),s||t.origin||c(!0)}!r&&s.current&&s.current.focus()}),[t,d,u,r]);return v.exports.useEffect((()=>{r&&c(!1)}),[r]),me("div",{className:""+(t.result?"event-input-result":"event-input"),children:[!t.result&&d&&me(Ee,{children:[u&&me(Ee,{children:[u.type!==V.BOOLEAN&&me("form",{onSubmit:e=>{e.preventDefault(),h()},children:[ve("input",{ref:s,id:d.id,autoComplete:"off",autoFocus:!0,type:u.type===V.STRING?"text":"number",placeholder:"Response...",value:r,onChange:e=>o(e.target.value),onFocus:e=>e.target.select()}),ve("button",{type:"submit",children:me("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16",children:[ve("path",{d:"M2 1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h9.586a2 2 0 0 1 1.414.586l2 2V2a1 1 0 0 0-1-1H2zm12-1a2 2 0 0 1 2 2v12.793a.5.5 0 0 1-.854.353l-2.853-2.853a1 1 0 0 0-.707-.293H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h12z"}),ve("path",{d:"M5 6a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"})]})})]}),u.type===V.BOOLEAN&&me("div",{className:"event-choices",children:[ve("button",{className:"event-choice",onClick:()=>h("true"),children:"Yes"},"event-passage-input-yes-btn"),ve("button",{className:"event-choice",onClick:()=>h("false"),children:"No"},"event-passage-input-no-btn")]}),l&&ve("div",{className:"engine-warning-message",children:"Missing route."})]}),!u&&ve("div",{className:"engine-warning-message",children:"Input variable required."})]}),t.result&&ve("button",{disabled:!0,children:Ke(t.result.value)})]})}));function Ke(e){switch(e){case"___passthrough___":return ve(Ee,{children:"Continue"});case"___loopback___":return ve(Ee,{children:Be});case"___gameover___":return ve(Ee,{children:"New Game"});default:return ve(Ee,{children:e})}}He.displayName="EventPassageInput";const Ye=m.memo((({passageId:e,event:t,onRouteFound:a})=>{const{engine:i,engineDispatch:n}=v.exports.useContext(Ne);if(!i.gameInfo)return null;const s=v.exports.useRef(null),{studioId:r,id:o}=i.gameInfo,l=g.exports.useLiveQuery((()=>new L(r).passages.get(e)),[e]),c=v.exports.useCallback((async({originId:e,result:i,route:n,state:s})=>{try{let l;if(n&&(l=await ce(r,await(async(e,t,a)=>{let i;switch(a){case A.PASSAGE:const a=await ce(e,t);a&&(i=a.id);break;case A.JUMP:const n=await le(e,t);if(n&&n.route[0]&&(n.route[1]&&(i=n.route[1]),!n.route[1])){const t=await he(e,n.route[0]);(null==t?void 0:t.children[0][1])&&(i=t.children[0][1])}}if(i)return i;throw"Unable to find destination. Missing passage."})(r,n.destinationId,n.destinationType))),!n&&("___gameover___"!==i.value&&e&&(l=await ce(r,e)),"___gameover___"===i.value)){const e=await re(r,o);e&&(l=await ce(r,e.destination))}if(!l)throw"Unable to process route. Could not find passage.";a({destinationId:l.id,eventResult:i,originId:(null==n?void 0:n.destinationType)===A.PASSAGE?e||t.destination:void 0,passageType:l.type,routeId:null==n?void 0:n.id,state:s})}catch(l){throw l}}),[l,t]),[d,u]=N((()=>({height:0,overflow:"hidden"})));return w(s,(()=>{s.current&&u.start({height:s.current.getBoundingClientRect().height+1})})),ve(T.div,{style:d,children:me("div",{className:"event-passage",style:{borderBottom:t.id===i.currentEvent?"none":"var(--event-passage-bottom-border)"},ref:s,children:[l&&me(Ee,{children:[ve(Ve,{content:l.content,state:t.state}),l.type===M.CHOICE&&ve(Xe,{passage:l,event:t,onSubmitRoute:c}),l.type===M.INPUT&&ve(He,{passage:l,event:t,onSubmitRoute:c})]}),!l&&me("div",{className:"engine-warning-message",children:["Passage missing or has been removed."," ",ve("a",{onClick:async()=>{n({type:Ie.SET_INSTALLED,installed:!1})},children:"Refresh"})," ","event stream."]})]})})}));Ye.displayName="EventPassage";const Qe=({data:e})=>{const{engine:t,engineDispatch:a}=v.exports.useContext(Ne);if(!t.gameInfo)return null;const{studioId:i,id:n}=t.gameInfo,s=g.exports.useLiveQuery((()=>new L(i).events.get(e.id)),[]);return ve("div",{className:"event "+((null==s?void 0:s.result)?"event-past":""),children:s&&ve(Ee,{children:ve(Ye,{passageId:e.destination,event:s,onRouteFound:async({destinationId:t,eventResult:r,originId:c,passageType:d,routeId:u,state:p})=>{try{await(async(e,t,a)=>{try{const i=new L(e),n=await i.events.get(t);n&&await i.events.update(t,l(o({},n),{result:a,updated:Date.now()}))}catch(i){throw i}})(i,e.id,r);const h=I();let v;switch(r.value){case"___gameover___":v=Y.RESTART;break;case"___loopback___":v=Y[d===M.CHOICE?"CHOICE_LOOPBACK":"INPUT_LOOPBACK"];break;default:v=Y[d]}const m=v===Y.RESTART?await re(i,n):void 0;if(v){await Promise.all([ne(i,e.id,h),ie(i,{gameId:n,id:h,destination:t,origin:c,state:(null==m?void 0:m.state)||u&&await ae(i,u,p||(null==s?void 0:s.state)||e.state)||p||(null==s?void 0:s.state)||e.state,prev:e.id,type:v,updated:Date.now()})]);const r=await te(i,`___auto___${n}`,h);await se(i,h,null==r?void 0:r.updated);const o=await oe(i,h);if(o){const t=await oe(i,e.id);t&&(a({type:Ie.UPDATE_EVENT_IN_STREAM,event:t}),a({type:Ie.APPEND_EVENTS_TO_STREAM,events:[o],reset:v===Y.RESTART}),a({type:Ie.SET_CURRENT_EVENT,id:h}))}}}catch(h){throw h}}})})})};Qe.displayName="Event";const qe=m.memo((()=>{const e=v.exports.useRef(null),{engine:t,engineDispatch:a}=v.exports.useContext(Ne),{settings:i}=v.exports.useContext(fe);if(!t.gameInfo)return null;const{studioId:n,id:s}=t.gameInfo,r=v.exports.useCallback((async()=>{if(t.installed&&t.currentEvent){const e=await(async(e,t,a,i)=>{const n=new L(e);try{let e=[];const s=await n.events.where("[gameId+updated]").between([t,d.minKey],[t,d.maxKey]).limit(i||10).reverse().toArray(),r=s.findIndex((e=>e.id===a)),o=s.findIndex((e=>e.type===Y.RESTART));return-1!==r&&(e=-1!==o?s.slice(r,o+1):s),e}catch(s){throw s}})(n,s,t.currentEvent,3);a({type:Ie.APPEND_EVENTS_TO_STREAM,events:e,reset:!0})}}),[t.installed,t.currentEvent]);E([`recentEvents-${t.installId}`,n,s,t.installed],(async()=>{try{await r()}catch(e){throw e}return!0}),{enabled:!!t.currentEvent,refetchOnMount:"always"});const c=g.exports.useLiveQuery((()=>new L(n).events.where({gameId:s}).toArray()),[]),u=g.exports.useLiveQuery((()=>new L(n).variables.where({gameId:s}).toArray()),[]);E([`variables-${t.installId}`,u],(async()=>{if(t.isEditor&&c&&u){const e={},t={};u.map((t=>e[t.id]=p.exports.cloneDeep(t))),Object.keys(e).map((a=>{const{title:i,type:n,initialValue:r}=p.exports.pick(e[a],["title","type","initialValue"]);t[a]={gameId:s,title:i,type:n,value:r}})),await Promise.all([c.map((async e=>{let t=p.exports.cloneDeep(e.state);Object.keys(e.state).map((e=>{const a=u.find((t=>t.id===e));a||delete t[e],a&&(t[e]=l(o({},t[e]),{title:a.title,type:a.type,value:t[e].type!==a.type?a.initialValue:t[e].value}))})),await Promise.all([u.map((async a=>{if(!e.state[a.id]){const{title:e,type:i,initialValue:n}=p.exports.pick(a,["title","type","initialValue"]);t[a.id]={gameId:s,title:e,type:i,value:n}}}))]),a({type:Ie.UPDATE_EVENT_IN_STREAM,event:l(o({},e),{state:t})}),await(async(e,t,a)=>{try{const i=new L(e),n=await i.events.get(t);n&&await i.events.update(t,l(o({},n),{state:a,updated:Date.now()}))}catch(i){throw i}})(n,e.id,t)}))])}}));const h=g.exports.useLiveQuery((()=>new L(n).games.get(s))),m=g.exports.useLiveQuery((()=>new L(n).jumps.where({gameId:s}).toArray()),[]);E([`game-jump-${t.installId}`,m],(async()=>{if(t.isEditor&&m){const e=m.find((e=>e.id===(null==h?void 0:h.jump)));if(e&&e.route[1]){const t=await new L(n).events.get(`___initial___${s}`);t&&t.destination!==e.route[1]&&(await(async(e,t,a)=>{try{const i=new L(e),n=await i.events.get(t);n&&await i.events.update(t,l(o({},n),{destination:a}))}catch(i){throw i}})(n,t.id,e.route[1]),a({type:Ie.SHOW_RESET_NOTIFICATION,message:"On game start jump has changed."}))}}}));const I=b(t.eventsInStream,{from:{opacity:0},enter:{opacity:1},config:{clamp:!0,mass:100,tension:500,friction:60},trail:50,delay:250,keys:t.eventsInStream.map((e=>e.id))});return w(e,(()=>e.current&&q(e.current))),v.exports.useEffect((()=>{e.current&&q(e.current)}),[t.devTools.xrayVisible]),ve(Ee,{children:ve("div",{id:"event-stream",style:{overflowY:i.open?"hidden":"auto",top:t.isEditor?"0":"",marginBottom:t.isEditor&&t.devTools.xrayVisible?250:0},children:ve("div",{id:"events",ref:e,children:I(((e,t)=>ve(T.div,{style:e,children:ve(Qe,{data:t},t.id)})))})})})}));qe.displayName="EventStream";const ze=()=>{const{engine:e,engineDispatch:t}=v.exports.useContext(Ne);return ve(Ee,{children:e.resetNotification.showing&&me("div",{id:"engine-reset-notification",children:[ve("span",{children:e.resetNotification.message}),ve("div",{style:{textAlign:"right"},children:ve("button",{onClick:()=>{t({type:Ie.HIDE_RESET_NOTIFICATION}),t({type:Ie.SET_INSTALLED,installed:!1})},children:"Refresh Event Stream"})})]})})};ze.displayName="ResetNotification";const Je=()=>{const{engine:e,engineDispatch:t}=v.exports.useContext(Ne),{data:a}=E("autoBookmark",(async()=>e.gameInfo&&await ee(e.gameInfo.studioId,e.gameInfo.id))),i=v.exports.useCallback((async()=>{if(e.gameInfo){const a=await te(e.gameInfo.studioId,`___auto___${e.gameInfo.id}`,`___initial___${e.gameInfo.id}`);a&&await se(e.gameInfo.studioId,`___initial___${e.gameInfo.id}`,a.updated),t({type:Ie.PLAY,fromEvent:`___initial___${e.gameInfo.id}`})}}),[e.gameInfo]),n=v.exports.useCallback((()=>{a&&t({type:Ie.PLAY,fromEvent:a.event})}),[a]);return v.exports.useEffect((()=>{e.gameInfo&&e.isEditor&&((null==a?void 0:a.event)?n():i())}),[e.gameInfo,e.isEditor]),ve("div",{id:"renderer",children:e.gameInfo&&me(Ee,{children:[!e.playing&&!e.isEditor&&ve(Le,{onStartGame:i,onContinueGame:n}),e.playing&&me(Ee,{children:[!e.isEditor&&ve(Ae,{}),ve(qe,{}),e.isEditor&&me(Ee,{children:[e.gameInfo&&e.devTools.xrayVisible&&ve("div",{style:{height:250,width:"100%",bottom:0,position:"absolute",background:"black",overflowY:"auto"},children:e.eventsInStream.length>0&&ve(xe,{event:e.eventsInStream[0]})}),ve(ze,{})]})]})]})})};Je.displayName="Renderer";const We=()=>{const{settingsDispatch:e}=v.exports.useContext(fe);return me("div",{id:"settings-title-bar",className:"title-bar",children:[ve("span",{id:"settings-title-bar-title",className:"title-bar-title",children:"Settings"}),ve("button",{onClick:()=>e({type:Te.CLOSE}),children:ve("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16",children:ve("path",{d:"M1.293 1.293a1 1 0 0 1 1.414 0L8 6.586l5.293-5.293a1 1 0 1 1 1.414 1.414L9.414 8l5.293 5.293a1 1 0 0 1-1.414 1.414L8 9.414l-5.293 5.293a1 1 0 0 1-1.414-1.414L6.586 8 1.293 2.707a1 1 0 0 1 0-1.414z"})})})]})};We.displayName="SettingsTitleBar";const Ze=()=>{const{engine:e}=v.exports.useContext(Ne),{settings:t,settingsDispatch:a}=v.exports.useContext(fe);if(!e.gameInfo)return null;const{studioId:i,id:n,copyright:s,description:r,designer:c,studioTitle:d,title:u,version:p,website:h}=e.gameInfo,m=v.exports.useCallback((async e=>{a({type:Te.SET_THEME,theme:e,closeSettings:!0}),await(async(e,t,a)=>{try{const i=new L(e),n=await i.settings.get(`__default__${t}`);if(!n)throw"Unable to save theme setting. Missing settings.";await i.settings.update(`__default__${t}`,l(o({},n),{theme:a}))}catch(i){throw i}})(i,n,e)}),[i]);return t.open?ve(Ee,{children:me("div",{id:"settings",children:[ve(We,{}),me("div",{id:"settings-content",children:[me("div",{children:[ve("h2",{children:"Theme"}),me("p",{children:[ve("a",{className:t.theme===F.CONSOLE?"settings-active-theme":"",onClick:()=>m(F.CONSOLE),children:"Console"})," ","|"," ",ve("a",{className:t.theme===F.BOOK?"settings-active-theme":"",onClick:()=>m(F.BOOK),children:"Book"})]})]}),me("div",{children:[ve("h2",{children:"Title"}),ve("p",{children:u})]}),r&&me("div",{children:[ve("h2",{children:"Description"}),ve("p",{children:r})]}),me("div",{children:[ve("h2",{children:"Studio"}),ve("p",{children:d})]}),me("div",{children:[ve("h2",{children:"Designer"}),ve("p",{children:c})]}),me("div",{children:[ve("h2",{children:"Version"}),ve("p",{children:p})]}),s&&me("div",{children:[ve("h2",{children:"Copyright"}),ve("p",{children:s})]}),h&&me("div",{children:[ve("h2",{children:"Website"}),ve("p",{children:ve("a",{href:h,children:h})})]}),me("div",{children:[ve("h2",{children:"Engine Mode"}),ve("p",{children:"production"})]}),me("div",{children:[ve("h2",{children:"Tools"}),ve("p",{children:ve("a",{onClick:async()=>{var t;(null==(t=e.gameInfo)?void 0:t.id)&&(await W(i,n),location.reload())},children:"Reset Game Data"})})]})]})]})}):null};Ze.displayName="Settings";const et=({children:e})=>{const{engine:t}=v.exports.useContext(Ne),{settings:a,settingsDispatch:i}=v.exports.useContext(fe),n=E(["theme",t],(async()=>{if(!t.gameInfo)return;const{studioId:e,id:a}=t.gameInfo;return await(async(e,t)=>{var a;try{return null==(a=await new L(e).settings.get(`__default__${t}`))?void 0:a.theme}catch(i){throw i}})(e,a)}));return v.exports.useEffect((()=>{n.data&&i({type:Te.SET_THEME,theme:n.data,closeSettings:!0})}),[n.data]),v.exports.useEffect((()=>{a.theme&&document.documentElement.setAttribute("data-theme",a.theme)}),[a.theme]),ve(Ee,{children:a.theme&&e})};et.displayName="Theme";const tt=m.memo((({children:e,studioId:t,gameId:a})=>{const{engine:i}=v.exports.useContext(Ne),n=g.exports.useLiveQuery((()=>new L(t).passages.where({gameId:a}).count()),[],-1),{data:s}=E([`startingDestination-${a}`,t,a,n],(async()=>{if(!i.installed)try{return!!(await Z(t,a))}catch(e){throw e}return!1}),{enabled:!i.installed&&n>0});return me(Ee,{children:[0===n&&!i.installed&&ve("div",{className:"engine-warning-message",style:{padding:"1.4rem"},children:"Scene and passage required to render game."}),(s||i.installed)&&ve(Ee,{children:e})]})}));tt.displayName="StartingDestinationGate";const at=()=>{const{engineDispatch:e}=v.exports.useContext(Ne),t=t=>{const{detail:a}=t;switch(a.eventType){case $.RESET:e({type:Ie.SET_INSTALLED,installed:!1});break;case $.TOGGLE_EXPRESSIONS:e({type:Ie.TOGGLE_DEVTOOLS_EXPRESSIONS});break;case $.TOGGLE_BLOCKED_CHOICES:e({type:Ie.TOGGLE_DEVTOOLS_BLOCKED_CHOICES});break;case $.TOGGLE_XRAY:e({type:Ie.TOGGLE_DEVTOOLS_XRAY});break;default:throw"Unknown engine event type."}};return v.exports.useEffect((()=>(window.addEventListener(H.EDITOR_TO_ENGINE,t),()=>{window.removeEventListener(H.EDITOR_TO_ENGINE,t)})),[]),null};at.displayName="DevTools";const it=new S({defaultOptions:{queries:{refetchOnWindowFocus:!1}}}),nt=m.memo((({studioId:e,game:{id:t,data:a,packed:i}})=>{const n=!!e,s=!n||a?localStorage.getItem(t):null,r=!s&&a?i?(o=a,u.unpack(o)):JSON.parse(a):void 0;var o;const l=e||(null==r?void 0:r._.studioId)||s&&JSON.parse(s).studioId;return ve(O,{client:it,children:ve(we,{children:l&&me(Ee,{children:[n&&ve(tt,{studioId:l,gameId:t,children:me(Ce,{studioId:l,gameId:t,data:r,isEditor:n,children:[ve(at,{}),ve(Je,{})]})}),!n&&ve(Ce,{studioId:l,gameId:t,data:r,isEditor:n,children:ve(Re,{children:me(et,{children:[ve(Ze,{}),ve(Je,{})]})})})]})})})}));nt.displayName="Runtime",function(){console.info(`powered by Elm Story ${String.fromCodePoint(128218)} 0.5.0 | https://elmstory.com`);const e=document.getElementById("runtime")||document.body;f.exports.render(ve(nt,{game:{id:"___gameId___",data:"___engineData___",packed:!0}}),e)}();
